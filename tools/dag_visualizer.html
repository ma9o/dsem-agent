<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DSEM DAG Visualizer</title>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      height: 100vh;
      display: flex;
    }

    /* Left panel - input */
    .input-panel {
      width: 320px;
      padding: 20px;
      background: #161b22;
      border-right: 1px solid #30363d;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    h1 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #f0f6fc;
    }
    textarea {
      flex: 1;
      min-height: 150px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      color: #c9d1d9;
      padding: 12px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 11px;
      resize: none;
      line-height: 1.5;
    }
    textarea:focus { outline: none; border-color: #58a6ff; }
    textarea::placeholder { color: #484f58; }
    button {
      padding: 10px 16px;
      background: #238636;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    button:hover { background: #2ea043; }
    .error {
      background: #f85149;
      color: white;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 12px;
      display: none;
    }

    /* Legend */
    .legend {
      background: #0d1117;
      padding: 14px;
      border-radius: 6px;
      border: 1px solid #30363d;
      font-size: 11px;
    }
    .legend h3 {
      margin-bottom: 8px;
      color: #8b949e;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
      color: #8b949e;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    .legend-line {
      width: 24px;
      height: 2px;
    }

    /* Graph */
    .graph-container {
      flex: 1;
      background: #0d1117;
      position: relative;
    }
    #graph { width: 100%; height: 100%; }

    /* Right panel - info */
    .info-panel {
      width: 300px;
      padding: 20px;
      background: #161b22;
      border-left: 1px solid #30363d;
      display: none;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
    }
    .info-panel.visible { display: flex; }
    .info-panel h2 {
      font-size: 1rem;
      font-weight: 600;
      color: #f0f6fc;
      padding-bottom: 12px;
      border-bottom: 1px solid #30363d;
      word-break: break-word;
    }
    .info-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .info-field .label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #8b949e;
    }
    .info-field .value {
      font-size: 13px;
      color: #c9d1d9;
      line-height: 1.4;
    }
    .info-field .value.highlight {
      color: #58a6ff;
      font-weight: 500;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    .tag.endogenous { background: #1f6feb33; color: #58a6ff; }
    .tag.exogenous { background: #da3633aa; color: #ff7b72; }
    .tag.observed { background: #238636aa; color: #3fb950; }
    .tag.latent { background: #6e768133; color: #8b949e; }
    .tag.outcome { background: #8957e5aa; color: #d2a8ff; }
    .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: #8b949e;
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
    }
    .close-btn:hover { color: #c9d1d9; background: none; }
  </style>
</head>
<body>
  <div class="input-panel">
    <h1>DSEM DAG Visualizer</h1>
    <textarea id="json-input" placeholder='Paste LLM JSON output...

{
  "dimensions": [...],
  "edges": [...]
}'></textarea>
    <button onclick="renderDAG()">Render DAG</button>
    <div class="error" id="error"></div>

    <div class="legend">
      <h3>Nodes</h3>
      <div class="legend-item">
        <div class="legend-color" style="background: #a371f7;"></div>
        <span>outcome (Y)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #58a6ff;"></div>
        <span>endogenous</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #f78166;"></div>
        <span>exogenous</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="border: 2px solid #8b949e; background: transparent;"></div>
        <span>latent (dashed border)</span>
      </div>
      <h3 style="margin-top: 10px;">Edges</h3>
      <div class="legend-item">
        <div class="legend-line" style="background: #8b949e;"></div>
        <span>contemporaneous</span>
      </div>
      <div class="legend-item">
        <div class="legend-line" style="background: repeating-linear-gradient(90deg, #8b949e 0px, #8b949e 3px, transparent 3px, transparent 6px);"></div>
        <span>lagged</span>
      </div>
      <h3 style="margin-top: 10px;">Selection</h3>
      <div class="legend-item">
        <div class="legend-line" style="background: #3fb950;"></div>
        <span>incoming (causes)</span>
      </div>
      <div class="legend-item">
        <div class="legend-line" style="background: #f78166;"></div>
        <span>outgoing (effects)</span>
      </div>
    </div>
  </div>

  <div class="graph-container">
    <div id="graph"></div>
  </div>

  <div class="info-panel" id="info-panel">
    <button class="close-btn" onclick="closeInfoPanel()">&times;</button>
    <h2 id="info-title"></h2>
    <div id="info-content"></div>
  </div>

  <script>
    let network = null;
    let nodesDataset = null;
    let edgesDataset = null;
    let originalEdgeColors = {};

    // Check for URL params on load
    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const data = params.get('data');
      if (data) {
        try {
          const json = decodeURIComponent(data);
          document.getElementById('json-input').value = json;
          renderDAG();
        } catch (e) {
          console.error('Failed to load data from URL:', e);
        }
      }
    });

    const COLORS = {
      endogenous: '#58a6ff',
      exogenous: '#f78166',
      outcome: '#a371f7',
      edgeDefault: '#8b949e',
      edgeIncoming: '#3fb950',
      edgeOutgoing: '#f78166',
      nodeBorder: '#30363d',
      nodeHighlight: '#f0f6fc'
    };

    function showError(msg) {
      const el = document.getElementById('error');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function closeInfoPanel() {
      document.getElementById('info-panel').classList.remove('visible');
      resetEdgeColors();
    }

    function resetEdgeColors() {
      if (!edgesDataset) return;
      const updates = [];
      edgesDataset.forEach(edge => {
        if (originalEdgeColors[edge.id]) {
          updates.push({ id: edge.id, color: originalEdgeColors[edge.id] });
        }
      });
      edgesDataset.update(updates);
    }

    function highlightEdges(nodeId) {
      if (!edgesDataset) return;
      const updates = [];
      edgesDataset.forEach(edge => {
        if (edge.to === nodeId) {
          // Incoming edge - green
          updates.push({
            id: edge.id,
            color: { color: COLORS.edgeIncoming, highlight: COLORS.edgeIncoming }
          });
        } else if (edge.from === nodeId) {
          // Outgoing edge - orange
          updates.push({
            id: edge.id,
            color: { color: COLORS.edgeOutgoing, highlight: COLORS.edgeOutgoing }
          });
        } else {
          // Dim other edges
          updates.push({
            id: edge.id,
            color: { color: '#30363d', highlight: '#30363d' }
          });
        }
      });
      edgesDataset.update(updates);
    }

    function renderDAG() {
      const input = document.getElementById('json-input').value.trim();
      if (!input) {
        showError('Please paste JSON first');
        return;
      }

      let data;
      try {
        data = JSON.parse(input);
      } catch (e) {
        showError('Invalid JSON: ' + e.message);
        return;
      }

      if (!data.dimensions || !data.edges) {
        showError('JSON must have "dimensions" and "edges" arrays');
        return;
      }

      // Build nodes
      const nodes = data.dimensions.map(dim => {
        // Outcome takes priority, then role
        let bgColor = dim.role === 'exogenous' ? COLORS.exogenous : COLORS.endogenous;
        if (dim.is_outcome) bgColor = COLORS.outcome;

        return {
          id: dim.name,
          label: dim.name + (dim.causal_granularity ? `\n(${dim.causal_granularity})` : ''),
          color: {
            background: bgColor,
            border: dim.observability === 'latent' ? '#6e7681' : COLORS.nodeBorder,
            highlight: { background: bgColor, border: COLORS.nodeHighlight }
          },
          borderWidth: dim.observability === 'latent' ? 2 : 1,
          shapeProperties: {
            borderDashes: dim.observability === 'latent' ? [4, 4] : false
          },
          font: { color: '#fff', size: 12, face: 'Inter, sans-serif' },
          _data: dim
        };
      });

      // Build edges
      const edges = data.edges.map((edge, i) => {
        const edgeColor = { color: COLORS.edgeDefault, highlight: COLORS.edgeDefault };
        originalEdgeColors[i] = { ...edgeColor };
        return {
          id: i,
          from: edge.cause,
          to: edge.effect,
          arrows: { to: { enabled: true, scaleFactor: 0.6 } },
          dashes: edge.lagged ? [6, 4] : false,
          color: edgeColor,
          width: 1.5,
          _data: edge
        };
      });

      // Check for missing nodes
      const nodeIds = new Set(nodes.map(n => n.id));
      for (const edge of data.edges) {
        if (!nodeIds.has(edge.cause)) {
          showError(`Edge references unknown cause: "${edge.cause}"`);
          return;
        }
        if (!nodeIds.has(edge.effect)) {
          showError(`Edge references unknown effect: "${edge.effect}"`);
          return;
        }
      }

      nodesDataset = new vis.DataSet(nodes);
      edgesDataset = new vis.DataSet(edges);

      const container = document.getElementById('graph');
      const visData = { nodes: nodesDataset, edges: edgesDataset };

      const options = {
        layout: { randomSeed: 42 },
        physics: {
          enabled: true,
          solver: 'forceAtlas2Based',
          forceAtlas2Based: {
            gravitationalConstant: -100,
            centralGravity: 0.008,
            springLength: 180,
            springConstant: 0.06,
            damping: 0.5,
            avoidOverlap: 0.9
          },
          stabilization: { iterations: 300, updateInterval: 25 }
        },
        interaction: {
          hover: true,
          tooltipDelay: 200,
          dragNodes: true
        },
        nodes: {
          shape: 'box',
          margin: { top: 8, bottom: 8, left: 12, right: 12 }
        },
        edges: {
          smooth: { type: 'cubicBezier', roundness: 0.4 }
        }
      };

      if (network) network.destroy();
      network = new vis.Network(container, visData, options);

      network.on('stabilizationIterationsDone', () => {
        network.setOptions({ physics: { enabled: false } });
      });

      network.on('click', function(params) {
        const panel = document.getElementById('info-panel');

        if (params.nodes.length > 0) {
          const nodeId = params.nodes[0];
          const node = nodes.find(n => n.id === nodeId);
          if (node && node._data) {
            showNodeInfo(node._data);
            highlightEdges(nodeId);
          }
        } else if (params.edges.length > 0) {
          const edgeId = params.edges[0];
          const edge = edges.find(e => e.id === edgeId);
          if (edge && edge._data) {
            showEdgeInfo(edge._data);
            resetEdgeColors();
          }
        } else {
          panel.classList.remove('visible');
          resetEdgeColors();
        }
      });
    }

    function showNodeInfo(dim) {
      document.getElementById('info-title').textContent = dim.name;
      document.getElementById('info-content').innerHTML = `
        <div class="info-field">
          <span class="label">Description</span>
          <span class="value">${dim.description}</span>
        </div>
        ${dim.is_outcome ? `<div class="info-field">
          <span class="tag outcome">OUTCOME (Y)</span>
        </div>` : ''}
        <div class="info-field">
          <span class="label">Role</span>
          <span class="tag ${dim.role}">${dim.role}</span>
        </div>
        <div class="info-field">
          <span class="label">Observability</span>
          <span class="tag ${dim.observability}">${dim.observability}</span>
        </div>
        <div class="info-field">
          <span class="label">Temporal Status</span>
          <span class="value">${dim.temporal_status}</span>
        </div>
        <div class="info-field">
          <span class="label">Causal Granularity</span>
          <span class="value">${dim.causal_granularity || '—'}</span>
        </div>
        <div class="info-field">
          <span class="label">Data Type</span>
          <span class="value">${dim.measurement_dtype}</span>
        </div>
        <div class="info-field">
          <span class="label">Aggregation</span>
          <span class="value">${dim.aggregation || '—'}</span>
        </div>
      `;
      document.getElementById('info-panel').classList.add('visible');
    }

    function showEdgeInfo(edge) {
      document.getElementById('info-title').textContent = `${edge.cause} → ${edge.effect}`;
      document.getElementById('info-content').innerHTML = `
        <div class="info-field">
          <span class="label">Description</span>
          <span class="value">${edge.description}</span>
        </div>
        <div class="info-field">
          <span class="label">Timing</span>
          <span class="value">${edge.lagged ? 'Lagged (t-1 → t)' : 'Contemporaneous (t → t)'}</span>
        </div>
      `;
      document.getElementById('info-panel').classList.add('visible');
    }
  </script>
</body>
</html>
